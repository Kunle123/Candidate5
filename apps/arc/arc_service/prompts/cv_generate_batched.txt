**CV GENERATION - BATCHED ROLE PROCESSING**

You are generating a complete CV using batched access to the candidate's profile (5 roles at a time).

**üö® CRITICAL BULLET RULE - READ THIS FIRST:**
**INCLUDE ALL MEANINGFUL, NON-REPETITIVE BULLETS**
- Start with ALL bullets from the profile for each role
- Remove ONLY if a bullet is genuinely repetitive or redundant within the SAME role
- Prioritize and reorder remaining bullets by job relevance
- **AVOID:** Arbitrary reduction (e.g., "max 3-4 bullets per role")
- **AIM FOR:** Include most/all bullets unless truly redundant
- **BALANCE:** Comprehensive coverage vs. avoiding repetition

**üö® MANDATORY PROCESS - STEP BY STEP:**

**STEP 1: Get Total Role Count**
- Call `get_role_count()` function FIRST
- This returns `{"role_count": N, "batch_size": 5}`
- Example: If N=17, you need to call get_roles_batch 4 times (0-4, 5-9, 10-14, 15-16)

**STEP 2: Get Candidate Metadata**
- Call `get_candidate_metadata()` to get projects, languages, interests
- This gives you everything EXCEPT work_experience

**STEP 3: Fetch All Role Batches**
- Call `get_roles_batch(start_index=0)` ‚Üí Returns roles 0-4
- Call `get_roles_batch(start_index=5)` ‚Üí Returns roles 5-9
- Call `get_roles_batch(start_index=10)` ‚Üí Returns roles 10-14
- Call `get_roles_batch(start_index=15)` ‚Üí Returns roles 15-16 (last batch)
- **Continue until you've fetched all N roles**

**STEP 4: Verify All Roles Received**
- Before generating CV, mentally list ALL companies from ALL batches:
  * Batch 0: [Company 1, Company 2, Company 3, Company 4, Company 5]
  * Batch 1: [Company 6, Company 7, Company 8, Company 9, Company 10]
  * Batch 2: [Company 11, Company 12, Company 13, Company 14, Company 15]
  * Batch 3: [Company 16, Company 17, ...]
- Count total companies = X
- Your CV MUST include exactly X role objects

**STEP 5: Generate Complete CV**
- Process ALL roles you received from ALL batches
- Create one role object in CV for each role from profile
- Order bullets within each role by job relevance
- FINAL CHECK: Count roles in your output JSON = must equal X from Step 4

**CRITICAL RULES:**

1. **MANDATORY:** Fetch ALL batches (if role_count=17, fetch batches at 0, 5, 10, 15)
2. **ZERO OMISSIONS:** Every role from every batch must appear in final CV
   - **DUPLICATE COMPANY NAMES:** If the same company appears multiple times with different dates, include BOTH/ALL as separate role objects
   - **EMPTY DESCRIPTIONS:** If a role has an empty description array, still include it with a generic bullet based on the job title
3. **AUTHENTIC BULLETS:** Use ONLY bullets from profile - no fabrication (except for roles with empty descriptions)
4. **DE-DUPLICATION:** Remove near-duplicate bullets within same role ONLY (not across different roles)
5. **SMART BULLET ORDERING:** Within each role, order bullets by:
   - Position 1-2: Most job-relevant bullets with quantifiable impact
   - Position 3+: Other relevant bullets, most impactful first
6. **DETAIL LEVEL:** Recent roles (1-3) should have maximum detail, older roles (16+) should be more concise
7. **PRIVACY & LOCATION HANDLING:** 
   - Use "{{CANDIDATE_NAME}}" for personal_information.name
   - Use "{{CONTACT_INFO}}" for personal_information.contact
   - Use "{{CANDIDATE_LOCATION_FROM_PROFILE}}" for personal_information.location ONLY
   - **COVER LETTER SIGNATURE:** End the cover letter with "Sincerely,\n\n{{CANDIDATE_NAME}}" (use placeholder, NOT actual name)
   - **CRITICAL - Work Experience Locations:**
     * Use ONLY the exact location from the profile if it exists
     * If location field is empty/null/missing in profile ‚Üí OMIT the location field entirely from that role
     * **DO NOT infer, guess, or fabricate locations**
     * **DO NOT use city names, country names, or "Remote" unless explicitly in profile**

**CONTENT VOLUME:**
- Target: 4+ pages
- Include ALL roles even if exceeds page target
- Completeness > page count

**BULLET DISTRIBUTION BY ROLE RECENCY:**

**üö® MANDATORY BULLET REQUIREMENTS - NON-NEGOTIABLE üö®**

**DEFAULT RULE: INCLUDE ALL BULLETS FROM PROFILE**

For each role, follow this STRICT process:
1. **EXTRACT** all bullets from the profile for that role
2. **COUNT** how many bullets the profile has: let's call this N
3. **REMOVE ONLY** exact duplicates or near-duplicates within that same role
4. **OUTPUT** remaining bullets (typically N or N-1 for recent roles, N-2 for older roles)

**MINIMUM BULLET REQUIREMENTS BY ROLE POSITION:**
- **Roles 1-3 (Most Recent):** MINIMUM 5 bullets (or ALL profile bullets if fewer than 5)
- **Roles 4-6:** MINIMUM 4 bullets (or ALL profile bullets if fewer than 4)
- **Roles 7-10:** MINIMUM 3 bullets (or ALL profile bullets if fewer than 3)
- **Roles 11-15:** MINIMUM 3 bullets (or ALL profile bullets if fewer than 3)
- **Roles 16+ (Oldest):** MINIMUM 2 bullets (or ALL profile bullets if fewer than 2)

**üö® CRITICAL RULES FOR BULLETS - VIOLATION = FAILED GENERATION:**
1. **PRESERVE DETAIL:** If the profile has 8 bullets for a recent role, you should output 7-8 bullets (remove only clear duplicates)
2. **NO AGGRESSIVE COMPRESSION:** Don't reduce 8 bullets down to 3-4 just to make CV "concise"
3. **MINIMUM ENFORCED:** Every role MUST meet the minimums above OR include ALL profile bullets (whichever is lower)
4. **NO FABRICATION:** Only use bullets from the profile
5. **SMART DE-DUPLICATION ONLY:** Remove bullets that are essentially identical within a role (e.g., "Managed team" and "Led team of 5" ‚Üí keep only second)
6. **REORDER BY RELEVANCE:** Top 2 bullets = most job-relevant with quantifiable results

**EXAMPLE:**
- Profile has 9 bullets for Role 1 (most recent) ‚Üí Output 8-9 bullets (remove only if truly duplicate)
- Profile has 6 bullets for Role 5 ‚Üí Output 5-6 bullets
- Profile has 3 bullets for Role 12 ‚Üí Output 3 bullets (meets minimum)
- Profile has 2 bullets for Role 17 (oldest) ‚Üí Output 2 bullets (meets minimum)

**ACHIEVEMENTS (RELEVANT ACHIEVEMENTS SECTION):**

This section showcases skills and experiences that are **particularly relevant to this specific job**.

**CRITICAL INSTRUCTIONS:**
1. **Extract 5-10 achievements** from across ALL work experience bullets that demonstrate skills/experience mentioned in the job description
2. **Prioritize by relevance:** Most job-relevant achievements first (priority 1), then supporting achievements (priority 2-3)
3. **Focus on quantifiable results:** Include metrics, numbers, or measurable outcomes wherever available in profile
4. **Cover key job requirements:** Ensure achievements collectively demonstrate the main skills/experiences the job requires
5. **Include evidence_source:** Note which company/role the achievement came from for traceability
6. **NO FABRICATION:** Only use achievements explicitly stated in the candidate's profile bullets

**Example Selection Logic for "Oracle Fusion Project Manager" role:**
- ‚úÖ INCLUDE: "Delivered complex integrations between Oracle Fusion and multiple systems" (directly relevant)
- ‚úÖ INCLUDE: "Coordinated 20+ suppliers for digital wallet implementation" (shows vendor management)
- ‚úÖ INCLUDE: "Led 50+ multidisciplinary teams for COVID logistics" (shows team leadership scale)
- ‚ùå SKIP: Generic responsibilities without outcomes (e.g., "Attended daily stand-ups")
- ‚ùå SKIP: Achievements totally unrelated to job requirements

**SKILLS:** Derive from work experience. Education/certifications added automatically (don't include in response).

**JSON STRUCTURE:**

**PRIORITY SYSTEM EXPLAINED:**
- `priority: 1` = Highly relevant to job (directly matches key requirements)
- `priority: 2` = Moderately relevant (supports job requirements)
- `priority: 3` = General/foundational (good to have but not central to job)

**PRIORITY ASSIGNMENT RULES:**
1. **Bullets**: Top 2-3 bullets per role get priority 1 (most job-relevant), rest get 2-3 based on relevance
2. **Achievements**: Top 5 most relevant get priority 1, rest get priority 2
3. **Projects**: Job-related projects get priority 1, others get priority 2-3
4. **Summary**: Always priority 1
5. **Skills**: Already grouped by priority_1/priority_2/priority_3 keys

```json
{
  "cv": {
    "personal_information": {
      "name": "{{CANDIDATE_NAME}}",
      "contact": "{{CONTACT_INFO}}",
      "professional_title": "Title from most recent role",
      "location": "{{CANDIDATE_LOCATION_FROM_PROFILE}}"
    },
    "professional_summary": {
      "content": "Comprehensive summary",
      "priority": 1
    },
    "professional_experience": {
      "roles": [
        {
          "company": "Company from profile",
          "title": "Title from profile",
          "start_date": "Start date from profile",
          "end_date": "End date from profile",
          "location": "ONLY include if present in profile - omit field entirely if not provided",
          "bullets": [
            {
              "content": "Most job-relevant bullet with quantifiable impact",
              "priority": 1,
              "relevance_score": 1
            },
            {
              "content": "Second most job-relevant bullet",
              "priority": 1,
              "relevance_score": 2
            },
            {
              "content": "Supporting bullet",
              "priority": 2,
              "relevance_score": 3
            },
            {
              "content": "General responsibility",
              "priority": 3,
              "relevance_score": 4
            }
          ]
        }
      ]
    },
    "achievements": [
      {
        "content": "Top achievement - directly matches key job requirement",
        "priority": 1,
        "evidence_source": "Company - Role"
      },
      {
        "content": "Strong achievement - supports job requirement",
        "priority": 2,
        "evidence_source": "Company - Role"
      }
    ],
    "technical_skills": {
      "priority_1": ["Core skills from job description"],
      "priority_2": ["Supporting technical skills"],
      "priority_3": ["Additional/foundational skills"]
    },
    "soft_skills": {
      "priority_1": ["Leadership, stakeholder management if in job"],
      "priority_2": ["Communication, teamwork"],
      "priority_3": ["General professional skills"]
    },
    "projects": [
      {
        "name": "Project name from profile",
        "description": "Description from profile",
        "priority": 1
      },
      {
        "name": "Less relevant project",
        "description": "Description",
        "priority": 2
      }
    ],
    "languages": ["Languages from profile"],
    "interests": ["Interests from profile"]
  },
  "cover_letter": {
    "content": "Comprehensive cover letter"
  },
  "job_alignment": {
    "job_title": "Job title from description",
    "company_name": "Company from description",
    "match_score": 85,
    "keywords_matched": ["Keywords from job"]
  }
}
```

**üö® VALIDATION BEFORE RETURNING:**

**ROLE COUNT VERIFICATION (MANDATORY - YOU WILL FAIL IF THIS IS WRONG):**
1. List EVERY company name AND date range from EVERY batch you fetched (including duplicates)
2. Count total roles across ALL batches you fetched: X roles
3. **CRITICAL:** If the same company appears twice with different dates (e.g., "Npower Digital May 2019-Dec 2019" AND "Npower Digital Jul 2017-Mar 2019"), count them as 2 SEPARATE roles
4. **CRITICAL:** If a role has an empty description array, still count it and include it in your CV
5. Count roles in your CV professional_experience.roles array: Y roles
6. **ABSOLUTE REQUIREMENT:** X must equal Y
7. If X ‚â† Y, you FAILED - DO NOT return the CV, regenerate with ALL missing roles

**Example Verification:**
- Batch 0: Allpay, TfL, Npower (May), Npower (Jul), B60 = 5 roles
- Batch 1: C3UK, National Grid, RBS, First Group, Storywall = 5 roles
- Batch 2: Vodafone, Acision, France Telecom, Orange PCS (PM), Orange PCS (R&D) = 5 roles
- Batch 3: Test Supply Chain, Transport for Wales = 2 roles
- **TOTAL: 5+5+5+2 = 17 roles**
- Your CV output MUST contain exactly 17 role objects in professional_experience.roles
- NO EXCEPTIONS - NO SUMMARIZATION - NO "MOST RELEVANT" SELECTION - ALL 17 ROLES

**If you return fewer than X roles, you have FAILED this task completely.**

**BULLET COUNT VERIFICATION (QUALITY CHECK):**
1. For EACH role in your output, count the bullets
2. Compare to the bullet count from the corresponding role in the profile
3. **GUIDELINE:** Aim to include most bullets from profile (e.g., 6-8 out of 9, not 3 out of 9)
4. **RED FLAG:** If a recent role has only 3 bullets but profile had 9, you over-reduced
5. **ACCEPTABLE:** If profile had 9 bullets with 3 near-duplicates, outputting 6-7 unique bullets is good

**Example Bullet Verification:**
- Profile Role 1 (Allpay): 9 bullets ‚Üí CV Output: 6-9 bullets (removed only duplicates)
- Profile Role 2 (TfL): 12 bullets ‚Üí CV Output: 8-12 bullets (kept meaningful detail)
- Profile Role 3 (Npower): 6 bullets ‚Üí CV Output: 5-6 bullets (minimal reduction)
- **AVOID:** Reducing 9 profile bullets to just 3 output bullets (too aggressive)

**FAILURE CONDITIONS:**
- ‚ùå Not fetching all batches (stopped at batch 2 when there were 4 batches)
- ‚ùå Role count mismatch (fetched 17, outputted 8)
- ‚ùå Omitting roles from any batch
- ‚ùå Fabricating bullets
- ‚ùå Including duplicate bullets
- ‚ùå **BULLET COUNT MISMATCH (fetched role with 9 bullets, outputted 3)**

Return ONLY the JSON object. No markdown formatting, no explanatory text.

